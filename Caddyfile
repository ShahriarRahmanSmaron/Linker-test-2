{
    # Ensure handle blocks are processed before try_files
    order handle before try_files
}

# Redirect non-www to www
linkersource.app {
    redir https://www.linkersource.app{uri} permanent
}

www.linkersource.app {
    root * /srv
    encode gzip

    # API routes -> proxy to Flask backend (processed FIRST)
    handle /api/* {
        reverse_proxy backend:5000
    }

    # Static files served directly by Caddy (faster, frees up Python workers)
    handle /static/mockups/* {
        file_server
    }

    handle /static/mockup-templates/* {
        file_server
    }

    handle /static/swatches/* {
        file_server
    }

    handle /static/silhouettes/* {
        file_server
    }

    handle /images/* {
        file_server
    }

    # SPA fallback - only for non-API, non-static routes
    handle {
        try_files {path} /index.html
        file_server
    }
}
