version: '3.8'

services:
  # Frontend build service
  frontend-build:
    image: node:20-alpine
    container_name: linker_frontend_build
    working_dir: /app
    volumes:
      - .:/app
      - /app/node_modules
    command: sh -c "npm install && npm run build"
    environment:
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - VITE_API_URL=${VITE_API_URL:-http://localhost:5000/api}
    profiles:
      - build

  backend:
    build: .
    container_name: linker_backend
    restart: always
    env_file:
      - .env
    environment:
      # Use Supabase database URL from environment
      DATABASE_URL: ${DATABASE_URL}
      # Supabase configuration
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
    volumes:
      - ./instance:/app/instance
      - ./fabric_swatches:/app/fabric_swatches
      - ./mockups:/app/mockups
      - ./masks:/app/masks
      - ./silhouettes:/app/silhouettes
      - ./Excel_files:/app/Excel_files
      - ./generated_mockups:/app/generated_mockups
      - ./generated_techpacks:/app/generated_techpacks
      - ./techpack_templates:/app/techpack_templates
      - ./images:/app/images
      # Mount SQL files for database setup
      - ./supabase_setup_complete.sql:/app/supabase_setup_complete.sql
      - ./supabase_security_fixes.sql:/app/supabase_security_fixes.sql
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  caddy:
    image: caddy:alpine
    container_name: linker_caddy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SITE_ADDRESS=${SITE_ADDRESS:-:80}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./dist:/srv
      # Static files served directly by Caddy (bypasses Python)
      - ./generated_mockups:/srv/static/mockups
      - ./mockups:/srv/static/mockup-templates
      - ./fabric_swatches:/srv/static/swatches
      - ./silhouettes:/srv/static/silhouettes
      - ./images:/srv/images
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - backend

volumes:
  caddy_data:
  caddy_config:
